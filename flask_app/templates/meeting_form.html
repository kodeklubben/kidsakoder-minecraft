{% from "security/_macros.html" import render_field_with_errors, render_field %}

{% macro meeting(form, world) %}

<link rel="stylesheet" href="/static/content/bootstrap-datetimepicker.min.css" />

<ul class="nav nav-tabs">
    <li class="active"><a href="#world-tab" data-toggle="tab">Velg verden</a></li>
    <li><a href="#meeting-tab" data-toggle="tab">Møtedetaljer</a></li>
</ul>

<div class="tab-content" style="padding-top: 15px">
    <div class="tab-pane fade in active" id="world-tab" style="opacity: 0;">
        <div class="row" id="gen-choise">
            <div class="col-md-4">
                <a href="{{ url_for('from_map') }}" class="btn btn-default thumbnail" id="kartverket-btn">
                    <span class="glyphicon glyphicon-globe" aria-hidden="true" style="font-size: 8em"></span>

                    <div class="caption">
                        <h2>Norgeskart</h2>
                        <p>
                            Lag en ny verden basert på et utsnitt av et kart over Norge.
                        </p>
                    </div>
                </a>
            </div>

            <div class="col-md-4">
                <a class="btn btn-default thumbnail" id="upload-btn">
                    <span class="glyphicon glyphicon-cloud-upload" aria-hidden="true" style="font-size: 8em"></span>

                    <div class="caption">
                        <h2>Last opp</h2>
                        <p>
                            Last opp en verden fra din datamaskin.
                        </p>
                    </div>
                </a>
            </div>

            <div class="col-md-4">
                <a class="btn btn-default thumbnail" id="template-btn">
                    <span class="glyphicon glyphicon-list" aria-hidden="true" style="font-size: 8em"></span>

                    <div class="caption">
                        <h2>Dine verdener</h2>
                        <p>
                            Lag et nytt møte basert på en lagret Minecraft verden.
                        </p>
                    </div>
                </a>
            </div>
        </div>

        <div class="row body-content">
            <button class="btn btn-default" id="back-btn" style="display: none">
                <span class="glyphicon glyphicon-arrow-left" aria-hidden="true"></span> Tilbake </button>

            <div id="template" style="display: none"></div>

            <div id="upload" style="display: none">

                <!-- Placeholder -->
                <div style="background-color: yellow; width: 100%; height: 400px;"></div>

            </div>
        </div>
    </div>

    <div class="tab-pane fade" id="meeting-tab">

        <form role="form" method="POST" action=" {{ action }}">
            {{ form.hidden_tag() }}
            <div class="row">
                <div class="col-md-6">
                    {{ render_field_with_errors(form.title, class="form-control") }}
                    {{ render_field_with_errors(form.participant_count, class="form-control") }}
                </div>

                <div class="col-md-6">
                    {{ render_field_with_errors(form.start_time, class="form-control", id="start_time") }}
                    {{ render_field_with_errors(form.end_time, class="form-control", id="end_time") }}
                </div>
            </div>

            {% if world %}
                <a href="{{ url_for('get_world', file_name=world.file_ref) }}">Last ned verden</a><br><br>
            {% endif %}

            <input type="submit" class="btn btn-default" value="Lagre">
            <a class="btn btn-default" href= {{ url_for('home') }}>Avbryt</a>
        </form>
    </div>
</div>

{% endmacro %}

{% macro meeting_scripts(set_tab) %}

<script type="text/javascript" src="/static/scripts/moment.js"></script>
<script type="text/javascript" src="/static/scripts/bootstrap-datetimepicker.min.js"></script>
<script type="text/javascript" src="/static/scripts/nb.js"></script>

<script type=text/javascript>
var obj_load={% if set_tab==1 %} 1 {% else %} 0 {% endif %};
tab_load=(obj_load ? "#meeting-tab" : "#");

$(document).ready(function () {
    $('#start_time').datetimepicker({
        locale: 'nb',
        showClose: true,
        toolbarPlacement: 'top',
        minDate: moment(),
        tooltips: {
            close: 'Lukk velgeren',
            selectTime: 'Velg tid',
            pickHour: 'Velg time',
            incrementHour: 'Øk timer',
            decrementHour: 'Reduser timer',
            pickMinute: 'Velg minutt',
            incrementMinute: 'Øk minutter',
            decrementMinute: 'Reduser minutter',
            selectMonth: 'Velg måned',
            prevMonth: 'Forrige måned',
            nextMonth: 'Neste måned',
            selectYear: 'Velg år',
            prevYear: 'Forrige år',
            nextYear: 'Neste år',
            selectDecade: 'Velg tiår',
            prevDecade: 'Forrige tiår',
            nextDecade: 'Neste tiår',
            prevCentury: 'Forrige århundre',
            nextCentury: 'Neste århundre'
        }
    });
    $('#end_time').datetimepicker({
        useCurrent: false
    });
    $('#end_time').data("DateTimePicker").options(
        $('#start_time').data("DateTimePicker").options()
    );
    $("#start_time").on("dp.change", function (e) {
        $('#end_time').data("DateTimePicker").minDate(e.date);
    });
});

$(document).ready(function() {
    /* Select tab on page load */
    if (location.hash || obj_load) {
        $('a[href=' + (location.hash || tab_load) + ']').tab('show');
    } else {
        document.getElementById("world-tab").style.opacity = "1";
    }

    /* World and detail tabs click event */
    $(".nav-tabs a").click(function(){
        $(this).tab('show');
        document.getElementById("world-tab").style.opacity = "1";
    });

    /* World list click event */
    $("#template-btn").click(function(){
        $("#gen-choise").hide();
        $("#template").show();
        $("#back-btn").show();

        world_list_loader();
    });

    /* Upload world click event */
    $("#upload-btn").click(function(){
        $("#gen-choise").hide();
        $("#upload").show();
        $("#back-btn").show();
    });

    /* Back button click event */
    $("#back-btn").click(function(){
        $("#kartverket").hide();
        $("#template").hide();
        $("#upload").hide();
        $("#back-btn").hide();
        $("#gen-choise").show();
    });

    function world_list_loader() {
        /* Load world list */
        $.get('{{ url_for('browse_worlds') }}', function (data) {
            $('#template').html(data);

            /* Toggle world favourite click event */
            $('.toggle_favourite_btn').click(function () {
                var world_id = $(this).val();
                console.log(world_id);
                $.getJSON('{{ url_for('toggle_favourite') }}' + world_id, function (data) {
                    console.log(data);
                    if (data.success) {
                        var favourite_star = $('#favourite_star_' + world_id);
                        if (data.favourite) {
                            favourite_star.removeClass('glyphicon-star-empty');
                            favourite_star.addClass('glyphicon-star');
                            favourite_star.css('color', '#FFD00F');
                        } else {
                            favourite_star.removeClass('glyphicon-star');
                            favourite_star.addClass('glyphicon-star-empty');
                            favourite_star.css('color', 'inherit');
                        }
                    }
                });
            });
            /* Delete world click event */
            $('.delete_world_btn').click(function () {
                var world_id = $(this).val();
                $.getJSON('{{ url_for('delete_world') }}' + world_id, function (data) {
                    var world_panel = $('#world_id_' + world_id);
                    if (data.success) {
                        world_panel.remove();
                    } else {
                        world_panel.append('<div class="alert alert-danger alert-dismissible" ' +
                                'style="margin-left:15px;margin-right:15px">' +
                                '<button type="button" class="close" data-dismiss="alert" aria-label="Close">' +
                                '<span aria-hidden="true">&times;</span></button>' +
                                data.message + '</div>');
                    }
                });

            });
            /* Use world click event */
            $('.use_world_btn').click(function () {
                var world_id = $(this).val();
                $('#world_id').val(world_id);
                $('a[href=#meeting-tab]').click();
            });
        });
    }

});
</script>

{% endmacro %}
